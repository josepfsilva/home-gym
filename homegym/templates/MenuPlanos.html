<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="{{url_for('static', filename='css/menu.css')}}">
    <title>HomeGym</title>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@latest/dist/svg.min.js"></script>
    <script src="static/js/mmi.js"></script>
    <script src="static/js/globals.js"></script>
    <script src="static/js/jquery-3.6.4.min.js"></script>
    <script src="static/js/webtoolkit.utf8.js"></script>
    <script src='static/js/datetime.js'></script>
    <script src="static/js/menuplanos.js"></script>

    <script type="module">

        let selectedPlan = 0;

        var mmiCli_Out_add = "wss://"+host+":8005/IM/USER1/";
        var mmiCli_Out = null;
        mmiCli_Out = new MMIClientSocket(mmiCli_Out_add + "APP");
        mmiCli_Out.onMessage.on(im1MessageHandler);
        mmiCli_Out.onOpen.on(socketOpenHandler);
        mmiCli_Out.openSocket();
      

        function socketOpenHandler(event) {
            console.log("---------------openSocketHandler---------------")
        
            if(mmiCli_Out.socket.readyState !== WebSocket.OPEN)
            {
                return;
            }
        }


        function im1MessageHandler(data) {
            console.log("--------------im1MessageHandler---------------");

            if(data != null && data!="RENEW" && data!="OK") {
                console.log(data);
                var content = $(data).find("emma\\:interpretation").first().text().trim();
                if (typeof content == 'string') {
                try {
                    // Try to parse XML
                    let message = JSON.parse(content);
                    console.log(selectedPlan);
                    if(message.hasOwnProperty('nlu') && message.nlu.intent == 'go_to_training_plans') {
                        window.location.href = '/meusplanos';
                        
                    }
                    else if(message.hasOwnProperty('nlu') && message.nlu.intent == 'go_to_mainpage') {
                        window.location.href = '/';
                    }
                    else if(message.hasOwnProperty('nlu') && message.nlu.intent == 'choose_training_plan') {
                        switch(message.nlu.nome_plano.toLowerCase()) {
                            case 'plano 1':                 //can be more generic (lol)
                                console.log('Plano 1');
                                loadPlanInfo(1);
                                if(PlanIdOrder(1)){
                                    selectedPlan = 1;
                                }
                                break;
                            case 'plano 2':
                                console.log('Plano 2');
                                loadPlanInfo(2);
                                if(PlanIdOrder(2)){
                                    selectedPlan = 2;
                                }
                                break;
                            case 'plano 3':
                                console.log('Plano 3');
                                loadPlanInfo(3);
                                if(PlanIdOrder(3)){
                                    selectedPlan = 3;
                                }
                                break;
                            case 'plano 4':
                                console.log('Plano 4');
                                loadPlanInfo(4);
                                if(PlanIdOrder(4)){
                                    selectedPlan = 4;
                                }
                                break;
                            case 'plano 5':
                                console.log('Plano 5');
                                loadPlanInfo(5);
                                if(checkIfPlanExists(5)){
                                    selectedPlan = 5;
                                }
                                break;
                            case 'plano 6':
                                console.log('Plano 6');
                                loadPlanInfo(6);
                                if(checkIfPlanExists(6)){
                                    selectedPlan = 6;
                                }
                                break;
                        }
                    }
                    else if(message.hasOwnProperty('nlu') && message.nlu.intent == 'start_plan' && selectedPlan != 0) {
                        window.location.href = '/meusplanos/plano'+selectedPlan;
                        
                    }
                    
                    console.log('plano selecionado:' + selectedPlan);
                }
                catch (e) { console.log(e); }
                }
            }
            else {
                    loadPlans();
                }
        }
        
        function loadContent(htmlFilePath) {
        
            var xhr = new XMLHttpRequest();
            xhr.open('GET', htmlFilePath, true);

            xhr.onload = function () {
                if (xhr.status >= 200 && xhr.status < 300) {
                    document.getElementById('content').innerHTML = xhr.responseText;
                } else {
                    console.error('Failed to load content');
                }
            };

            xhr.onerror = function () {
                console.error('Network error occurred');
            };

            xhr.send();
        }
    </script>
    
    <div class="profile">
        <div class = "welcome">
            <div class="container2"></div>
            <div class="text">
            <h1>Bem vindo,</h1>
            <h2>{{username}}</h2>
            
            <!-- {%for user in users%}
                    <h2>Maria</h2>
            {%endfor%} -->
            </div>
        </div>
        <p id="datetime" class="datetime-container">
            <span class="time"></span>
            <span class="date"></span>
        </p>
        
    </div>
    <div id="content" class="animated-content"></div> 

    
    
        

    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>