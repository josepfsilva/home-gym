<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="{{url_for('static', filename='css/plano.css')}}"
    />
    <title>HomeGym</title>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@latest/dist/svg.min.js"></script>
    <script src="../static/js/mmi.js"></script>
    <script src="../static/js/globals.js"></script>
    <script src="../static/js/jquery-3.6.4.min.js"></script>
    <script src="../static/js/webtoolkit.utf8.js"></script>
    <script src="../static/js/menuplanos.js"></script>
    <script src="../static/js/planox.js"></script>
    <script src="../static/js/datetime.js"></script>

    <script type="module">

        let count = 0;
        var shouldContinue = true;
        var planStart = false;
        let startTime = 0;
        let exDuration = 0;

        var mmiCli_Out_add = "wss://"+host+":8005/IM/USER1/";
        var mmiCli_Out = null;
        mmiCli_Out = new MMIClientSocket(mmiCli_Out_add + "APP");
        mmiCli_Out.onMessage.on(im1MessageHandler);
        mmiCli_Out.onOpen.on(socketOpenHandler);
        mmiCli_Out.openSocket();
      

        function socketOpenHandler(event) {
            console.log("---------------openSocketHandler---------------")
        
            if(mmiCli_Out.socket.readyState !== WebSocket.OPEN)
            {
                return;
            }
        }

        function im1MessageHandler(data) {
            console.log("--------------im1MessageHandler---------------");

            if(data != null && data!="RENEW" && data!="OK") {
                console.log(data);
                var content = $(data).find("emma\\:interpretation").first().text().trim();
                if (typeof content == 'string') {
                try {
                    let message = JSON.parse(content);
                    if(message.hasOwnProperty('nlu') && (message.nlu.intent == 'finish_plan' || (message.nlu.intent == 'next_exercise' && count == 2)) && planStart == true) { 
                        //terminar plano ou avançar do ultimo exercicio
                        shouldContinue = false;
                        let elapsedTime = getElapsedTime(); //mandar para a db
                        planStart = false;
                        setTimeout(() => {  //esperar pelo fim do outro timer
                            clearDivs();
                            document.getElementById('exercise').innerHTML = "You have finished your plan! Congratulations!";
                            
                            //load stats
                            document.getElementById('elapsedTime').innerHTML = "Tempo total de treino: " + formatTime(elapsedTime);

                
               
                        }, 1000); // Delay for 1 second
                    }
                    else if(message.hasOwnProperty('nlu') && message.nlu.intent == 'start_plan' && count == 0 && planStart == false) {
                        planStart = true;
                        startTime = Date.now();
                        let planNumber = getPlanNumber();
                        loadPlanHead(planNumber)
                            .then(() => {
                                console.log(count);
                                return loadExercise(planNumber, count);
                            })
                            .then(() => getPlanDuration(planNumber))
                            .then(duration => {
                                exDuration = duration / 3; // Split the duration into three equal parts
                                return runForTime(exDuration);
                            })
                            .then(result => {
                                console.log(result.message); // 'Operation completed'
                                //console.log(result.incompleteEx); // false
                                count += 1;
                                
                                clearDivs();
                                document.getElementById('exercise').innerHTML = "Exercício terminado! Diga Avançar para começar o proximo exercício.";
                            })
                            .catch(error => {
                                console.log('Timer was stopped')
                                if (error.incompleteEx) {
                                    //console.log(error.incompleteEx); // true
                                    count += 1;
                                }
                            });

                        
                    }
                    else if(message.hasOwnProperty('nlu') && message.nlu.intent == 'next_exercise' && count<3 && planStart == true) { //avançar exercicio
                        shouldContinue = false;
                        setTimeout(() => {  //esperar pelo fim do outro timer
                            let planNumber = getPlanNumber();
                            loadPlanHead(planNumber)
                                .then(() => {                     
                                    console.log(count);
                                    shouldContinue = true;
                                    return loadExercise(planNumber,count);
                                })
                                .then(() => runForTime(exDuration))
                                .then(result => {
                                    console.log(result.message); // 'Operation completed'
                                    //console.log(result.incompleteEx); // false
                                    count += 1;
                                    clearDivs();
                                    document.getElementById('exercise').innerHTML = "Exercício terminado! Diga Avançar para começar o proximo exercício.";
                                })
                                .catch(error => {
                                    console.log('Timer was stopped')
                                    if (error.incompleteEx) {
                                        //console.log(error.incompleteEx); // true
                                        count += 1;
                                }
                                });
                        }, 1000); // Delay for 1 second
                    
                    }
                    else if(message.hasOwnProperty('nlu') && message.nlu.intent == 'go_to_training_plans'){   //por condição caso já esteja a meio de um plano
                        window.location.href = "/meusplanos";
                    }
                }
                catch (e) { console.log(e); }
                }
            }
            else {
                let planNumber = getPlanNumber();
                loadPlanInfo(planNumber);
            }
        }

        function clearDivs() {
            document.getElementById('timer').innerHTML = "";
            document.getElementById('exercise').innerHTML = "";
            document.getElementById('videoFrame').src = "";

        }

        function getElapsedTime() {
            let elapsedTime = Date.now() - startTime;
            return elapsedTime;
        }

        function runForTime(seconds) {
            return new Promise((resolve, reject) => {
                let incompleteEx = false;
                let timerElement = document.getElementById('timer');
                let timeLeft = seconds;
                timerElement.textContent = timeLeft;

                function tick() {
                    timeLeft--;
                    timerElement.textContent = timeLeft;

                    if (timeLeft > 0) {
                        let sc = shouldContinue;
                        if (sc) {
                            setTimeout(tick, 1000);
                        } else {
                            incompleteEx = true;
                            reject({message: 'Operation was cancelled', incompleteEx: incompleteEx});
                        }
                    } else {
                        if (shouldContinue) {
                            resolve({message: 'Operation completed', incompleteEx: incompleteEx});
                        } else {
                            reject({message: 'Operation was cancelled', incompleteEx: incompleteEx});
                        }
                    }
                }

                if (shouldContinue) {
                    setTimeout(tick, 1000);
                } else {
                    incompleteEx = true;
                    reject({message: 'Operation was cancelled', incompleteEx: incompleteEx});
                }
            });
        
        }

    </script>

    <div id="content"></div>
    <div id="elapsedTime"></div>
    <div id="timer"></div>
    <div id="exercise"></div>
        <iframe
        id="videoFrame"
        frameborder="0"
        style="
        position: fixed; 
        top: 0; 
        left: 0; 
        bottom: 0; 
        right: 0; 
        width: 100%; 
        height: 100%; 
        z-index: 99; 
        "
        allow="autoplay; fullscreen"
        ></iframe>
  </body>
</html>
