<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="{{url_for('static', filename='css/menu.css')}}">
    <title>HomeGym</title>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@latest/dist/svg.min.js"></script>
    <script src="../static/js/mmi.js"></script>
    <script src="../static/js/globals.js"></script>
    <script src="../static/js/jquery-3.6.4.min.js"></script>
    <script src="../static/js/webtoolkit.utf8.js"></script>
    <script src="../static/js/menuplanos.js"></script>
    <script src="../static/js/planox.js"></script>

    <script type="module">

        let selectedPlan = 0;

        var mmiCli_Out_add = "wss://"+host+":8005/IM/USER1/";
        var mmiCli_Out = null;
        mmiCli_Out = new MMIClientSocket(mmiCli_Out_add + "APP");
        mmiCli_Out.onMessage.on(im1MessageHandler);
        mmiCli_Out.onOpen.on(socketOpenHandler);
        mmiCli_Out.openSocket();
      

        function socketOpenHandler(event) {
            console.log("---------------openSocketHandler---------------")
        
            if(mmiCli_Out.socket.readyState !== WebSocket.OPEN)
            {
                return;
            }
        }


        function im1MessageHandler(data) {
            console.log("--------------im1MessageHandler---------------");

            if(data != null && data!="RENEW" && data!="OK") {
                console.log(data);
                var content = $(data).find("emma\\:interpretation").first().text().trim();
                if (typeof content == 'string') {
                try {
                    // Try to parse XML
                    let message = JSON.parse(content);

                }
                catch (e) { console.log(e); }
                }
            }
            else {
                    load();
                    timer()
                }
        }

        function load() {
            let url = new URL(window.location.href);
            let pathSegments = url.pathname.split('/');
            // Get the plan number
            let planNumber = parseInt(pathSegments[pathSegments.length - 1].replace(/\D/g, ''));
            console.log(planNumber);

            checkIfPlanExists(planNumber).then(exists => {
                console.log(exists);
                if (exists) {
                    console.log(planNumber)
                    LoadPlanStart(planNumber);
                }
            });
        }
    </script>

    <div id="content"></div>
    <div id="timer" class="timer">10</div>
    </div>

</body>
</html>