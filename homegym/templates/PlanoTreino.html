<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="{{url_for('static', filename='css/plano.css')}}"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>HomeGym</title>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@latest/dist/svg.min.js"></script>
    <script src="../static/js/mmi.js"></script>
    <script src="../static/js/globals.js"></script>
    <script src="../static/js/jquery-3.6.4.min.js"></script>
    <script src="../static/js/webtoolkit.utf8.js"></script>
    <script src="../static/js/menuplanos.js"></script>
    <script src="../static/js/planox.js"></script>
    <script src="../static/js/datetime.js"></script>
    <script src="../static/js/geral.js"></script>
    <script src="../static/js/newsession.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    

    <script type="module">

        let count = -1;
        var shouldContinue = true;
        var planStart = false;
        let startTime = 0;
        let exDuration = 0;
        let planNumber = getPlanNumber();

        var mmiCli_Out_add = "wss://"+host+":8005/IM/USER1/";
        var mmiCli_Out = null;
        mmiCli_Out = new MMIClientSocket(mmiCli_Out_add + "APP");
        mmiCli_Out.onMessage.on(im1MessageHandler);
        mmiCli_Out.onOpen.on(socketOpenHandler);
        mmiCli_Out.openSocket();
      

        function socketOpenHandler(event) {
            console.log("---------------openSocketHandler---------------")
        
            if(mmiCli_Out.socket.readyState !== WebSocket.OPEN)
            {
                return;
            }
        }

        function im1MessageHandler(data) {
            console.log("--------------im1MessageHandler---------------");

            if(data != null && data!="RENEW" && data!="OK") {
                console.log(data);
                var content = $(data).find("emma\\:interpretation").first().text().trim();
                if (typeof content == 'string') {
                try {
                    let message = JSON.parse(content);
                    if(message.hasOwnProperty('nlu') && (message.nlu.intent == 'finish_plan' || (message.nlu.intent == 'next_exercise' && count == 2)) && planStart == true) { 
                        shouldContinue = false;
                        let elapsedTime = getElapsedTime();
                        planStart = false;

                        setTimeout(() => {  //esperar pelo fim do outro timer
                            clearDivs();
                            removetimerimage();
                            changeZIndex("0");

                            if (count == 2) { //only counts if went through all exercises
                                document.getElementById('exercise').innerHTML = '<div class="endtext">Finalizou o Plano de Treino. Parabéns!</div><div>';
                                document.getElementById('elapsedTime').innerHTML = "Tempo Total de Treino:<p>" + formatTime(elapsedTime) + "</p>";
                                sendFinishPlan(elapsedTime, planNumber) //send to db
                                    .then(() => {
                                        showAwardedBadges(); //show badges if awarded
                                    })
                                    .then(() => {
                                        return new Promise((resolve) => setTimeout(resolve, 2000)); // Wait for 2 seconds
                                    })
                                    .then(() => {
                                        showLevel();
                                    })
                                    .then(() => {
                                        return new Promise((resolve) => setTimeout(resolve, 1000)); // Wait for 2 seconds
                                    })
                                    .then(() => {
                                        console.log("showing progress");
                                        showLevelProgress();
                                    })
                                    .catch((error) => {
                                        console.error('Error:', error);
                                    });
                            }else{
                                document.getElementById('exercise').innerHTML = '<div class="endtext">Para concluir o Plano precisa de fazer todos os Exercícios!</div>';
                                document.getElementById('elapsedTime').innerHTML = "Tente novamente.";
                                document.getElementById('badges').innerHTML = '<i class="fa fa-refresh fa-spin" style="font-size:50px; margin-left:-50px;"></i>';

                            }
               
                        }, 1000);
                    }
                    else if(message.hasOwnProperty('nlu') && message.nlu.intent == 'start_plan' && count == -1 && planStart == false) {
                        planStart = true;
                        startTime = Date.now();
                        
                        loadPlanHead(planNumber)
                            .then(() => {
                                count+=1;
                                changeZIndex("100");
                                addtimerimage();
                                return loadExercise(planNumber, count);
                            })
                            .then(() => getPlanDuration(planNumber))
                            .then(duration => {
                                exDuration = duration / 3; // Split the duration into three equal parts
                                return runForTime(exDuration);
                            })
                            .then(result => {
                                console.log(result.message); // 'Operation completed'
                                //console.log(result.incompleteEx); // false
                                clearDivs();
                                removetimerimage();
                                changeZIndex("0");
                                addfooter();
                                resting();
                            })
                            .catch(error => {
                                console.log('Timer was stopped')
                                if (error.incompleteEx) {
                                    //console.log(error.incompleteEx); // true
                                }
                            });

                        
                    }
                    else if(message.hasOwnProperty('nlu') && message.nlu.intent == 'next_exercise' && count<2 && planStart == true) { //avançar exercicio
                        shouldContinue = false;
                        setTimeout(() => {  //esperar pelo fim do outro timer
                            loadPlanHead(planNumber)
                                .then(() => {
                                    count+=1;
                                    console.log(count);
                                    shouldContinue = true;
                                    changeZIndex("100");
                                    addtimerimage();
                                    return loadExercise(planNumber,count);
                                })
                                .then(() => runForTime(exDuration))
                                .then(result => {
                                    console.log(result.message); // 'Operation completed'
                                    //console.log(result.incompleteEx); // false
                                    clearDivs();
                                    removetimerimage();
                                    changeZIndex("0");
                                    addfooter();
                                    resting();
                                })
                                .catch(error => {
                                    console.log('Timer was stopped')
                                    if (error.incompleteEx) {
                                        //console.log(error.incompleteEx); // true
                                    }
                                });
                        }, 1000); // Delay for 1 second
                    
                    }
                    else if(message.hasOwnProperty('nlu') && (message.nlu.intent == 'go_to_training_plans' || message.nlu.intent == 'go_to_mainpage') && planStart == false){   //por condição caso já esteja a meio de um plano
                        if(message.nlu.intent == 'go_to_training_plans')
                            window.location.href = "/meusplanos";
                        else if(message.nlu.intent == 'go_to_mainpage')
                            window.location.href = "/";
                    }
                }
                catch (e) { console.log(e); }
                }
            }
            else {
                loadPlanInfo(planNumber)
                .then(() => {
                    return new Promise((resolve) => setTimeout(resolve, 1000));
                })
                .then(() => {
                    showLevel();
                })
                .catch((error) => {
                    console.error('Error:', error);
                });

                //let onlineF = getOnlineFriends();    //get online friends

            }
        }

        function clearDivs() {
            document.getElementById('foot').innerHTML = "";
            document.getElementById('timer').innerHTML = "";
            document.getElementById('exercise').innerHTML = "";
            document.getElementById('videoFrame').src = "";
            document.getElementById('elapsedTime').innerHTML = "";

        }

        //this functions need to be here
        function getElapsedTime() {
            let elapTime = Date.now() - startTime;
            return elapTime;
        }

        function resting() {
            var container = $('#exercise')
            container.empty();
            if (count < 2) {
                document.getElementById('exercise').innerHTML = `
                    <div class="rest">
                        <div class="Alert">
                            <h4>Exercício ${count+1} Terminado! Diga Avançar para começar o proximo Exercício.</h4>
                        </div>
                        <div class="stopwatch-container"> 
                            <img src="../static/img/stopwatch.png" />
                        </div>
                    </div>`;
            }
            else {
                document.getElementById('exercise').innerHTML = `
                    <div class="rest">
                        <div class="Alert">
                            <h4>Exercício ${count+1} Terminado! Diga Terminar para Concluir o Plano.</h4>
                        </div>
                        <div class="stopwatch-container"> 
                            <img src="../static/img/stopwatch.png" />
                        </div>
                    </div>`;
            }
        }

        function runForTime(seconds) {
            return new Promise((resolve, reject) => {
                let incompleteEx = false;
                let timerElement = document.getElementById('timer');
                let timeLeft = seconds;
                timerElement.textContent = timeLeft;

                function tick() {
                    timeLeft--;
                    timerElement.textContent = timeLeft;

                    if (timeLeft > 0) {
                        if (shouldContinue) {
                            setTimeout(tick, 1000);
                        } else {
                            incompleteEx = true;
                            reject({message: 'Operation was cancelled', incompleteEx: incompleteEx});
                        }
                    } else {
                        if (shouldContinue) {
                            resolve({message: 'Operation completed', incompleteEx: incompleteEx});
                        } else {
                            reject({message: 'Operation was cancelled', incompleteEx: incompleteEx});
                        }
                    }
                }

                if (shouldContinue) {
                    setTimeout(tick, 1000);
                } else {
                    incompleteEx = true;
                    reject({message: 'Operation was cancelled', incompleteEx: incompleteEx});
                }
            });
        
        }

    </script>

    <div id="content"></div>
    <div id="timerContainer">
        <div id="timer"></div>
    </div>
    <div id="exercise"></div>
        <iframe
        id="videoFrame"
        frameborder="0"
        style="
        position: fixed; 
        top: 0; 
        left: 0; 
        bottom: 0; 
        right: 0; 
        width: 100%; 
        height: 100%; 
        z-index: 99; 
        "
        allow="autoplay; fullscreen"
        ></iframe>
        <div id="endcontainer">
            <div class="elapsedTime-badges">
                <div id="elapsedTime"></div>
                <div id="badges"></div>
            </div>
            <div id="pgbar"></div>
        </div>
        <div id="foot"></div>
  </body>
</html>
